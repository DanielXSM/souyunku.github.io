---
layout: post
title: MongoDB分片（sharding） / 分区
categories: MongoDB
description: MongoDB分片（sharding） / 分区
keywords: MongoDB
---

# MongoDB分片（sharding） / 分区

# 1. 安装 MongoDB

三台机器

关闭防火墙

```sh
systemctl stop firewalld.service 
```

192.168.252.121 | 192.168.252.122 | 192.168.252.123
---|---|---|
mongos					| mongos					| mongos
config server			| config server				| config server
shard server1 主节点	| 	shard server1 副节点	| shard server1 仲裁
shard server2 仲裁		| shard server2 主节点		| shard server2 副节点
shard server3 副节点	| 	shard server3 仲裁		| shard server3 主节点

端口分配：

```sh
mongos：20000
config：21000
shard1：27001
shard2：27002
shard3：27003
```

下载并且安装

```sh
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-amazon-3.6.2.tgz
tar -xzvf mongodb-linux-x86_64-amazon-3.6.2.tgz  -C /usr/local/
```

所有版本二进制文件,自行下载
 
```sh
https://www.mongodb.org/dl/win32/x86_64-2008plus-ssl?_ga=2.87139544.1567998244.1517190032-1153843332.1517190032&_gac=1.204211492.1517212002.EAIaIQobChMI44v9_9b82AIV1AcqCh0lcABIEAAYASAAEgKI1_D_BwE
```

改名

```sh
cd /usr/local/
mv  mongodb-linux-x86_64-amazon-3.6.2 mongodb
```

分别在每台机器建立conf、mongos、config、shard1、shard2、shard3六个目录，因为mongos不存储数据，只需要建立日志文件目录即可。

```sh
mkdir -p /usr/local/mongodb/conf \
mkdir -p /usr/local/mongodb/mongos/log \
mkdir -p /usr/local/mongodb/config/data \
mkdir -p /usr/local/mongodb/config/log \
mkdir -p /usr/local/mongodb/shard1/data \
mkdir -p /usr/local/mongodb/shard1/log \
mkdir -p /usr/local/mongodb/shard2/data \
mkdir -p /usr/local/mongodb/shard2/log \
mkdir -p /usr/local/mongodb/shard3/data \
mkdir -p /usr/local/mongodb/shard3/log
```

配置环境变量

```sh
vi /etc/profile
# MongoDB 环境变量内容
export MONGODB_HOME=/usr/local/mongodb
export PATH=$MONGODB_HOME/bin:$PATH
```

使立即生效

```sh
source /etc/profile
```

# 2. config server配置服务器

mongodb3.4以后要求配置服务器也创建副本集，不然集群搭建不成功。

(三台机器)添加配置文件

```sh
vi /usr/local/mongodb/conf/config.conf

## 配置文件内容
pidfilepath = /usr/local/mongodb/config/log/configsrv.pid
dbpath = /usr/local/mongodb/config/data
logpath = /usr/local/mongodb/config/log/congigsrv.log
logappend = true
 
bind_ip = 0.0.0.0
port = 21000
fork = true
 
#declare this is a config db of a cluster;
configsvr = true

#副本集名称
replSet = configs
 
#设置最大连接数
maxConns = 20000
```

启动三台服务器的config server

```sh
mongod -f /usr/local/mongodb/conf/config.conf
```

登录任意一台配置服务器，初始化配置副本集

连接 MongoDB

```sh
mongo --port 21000
```

config 变量

```sh
config = {
	_id : "configs",
	members : [
	{_id : 0, host : "192.168.252.121:21000" },
	{_id : 1, host : "192.168.252.122:21000" },
	{_id : 2, host : "192.168.252.123:21000" }
	]
}
```

初始化副本集

```sh
rs.initiate(config)
```

其中，"_id" : "configs"应与配置文件中配置的 replicaction.replSetName 一致，"members" 中的 "host" 为三个节点的 ip 和 port

响应内容如下

```sh
> config = {
... _id : "configs",
... members : [
... {_id : 0, host : "192.168.252.121:21000" },
... {_id : 1, host : "192.168.252.122:21000" },
... {_id : 2, host : "192.168.252.123:21000" }
... ]
... }
{
	"_id" : "configs",
	"members" : [
		{
			"_id" : 0,
			"host" : "192.168.252.121:21000"
		},
		{
			"_id" : 1,
			"host" : "192.168.252.122:21000"
		},
		{
			"_id" : 2,
			"host" : "192.168.252.123:21000"
		}
	]
}
> rs.initiate(config);
{
	"ok" : 1,
	"operationTime" : Timestamp(1517369899, 1),
	"$gleStats" : {
		"lastOpTime" : Timestamp(1517369899, 1),
		"electionId" : ObjectId("000000000000000000000000")
	},
	"$clusterTime" : {
		"clusterTime" : Timestamp(1517369899, 1),
		"signature" : {
			"hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),
			"keyId" : NumberLong(0)
		}
	}
}
configs:SECONDARY>
```

此时会发现终端上的输出已经有了变化。

```
//从单个一个
>
//变成了
configs:SECONDARY>
```

查询状态

```sh
configs:SECONDARY> rs.status()
```

# 3. 配置分片副本集

## 3.1 设置第一个分片副本集

(三台机器)设置第一个分片副本集

配置文件

```sh
vi /usr/local/mongodb/conf/shard1.conf

#配置文件内容
#——————————————–
pidfilepath = /usr/local/mongodb/shard1/log/shard1.pid
dbpath = /usr/local/mongodb/shard1/data
logpath = /usr/local/mongodb/shard1/log/shard1.log
logappend = true

bind_ip = 0.0.0.0
port = 27001
fork = true
 
#副本集名称
replSet = shard1
 
#declare this is a shard db of a cluster;
shardsvr = true
 
#设置最大连接数
maxConns = 20000
```

启动三台服务器的shard1 server

```sh
mongod -f /usr/local/mongodb/conf/shard1.conf
```

登陆任意一台服务器，初始化副本集(除了192.168.252.123)

连接 MongoDB

```sh
mongo --port 27001
```

使用admin数据库

```sh
use admin
```

定义副本集配置

```sh
config = {
    _id : "shard1",
     members : [
         {_id : 0, host : "192.168.252.121:27001" },
         {_id : 1, host : "192.168.252.122:27001" },
         {_id : 2, host : "192.168.252.123:27001" , arbiterOnly: true }
     ]
 }
```

初始化副本集配置

```sh
rs.initiate(config)
```

响应内容如下

```sh
> use admin
switched to db admin
> config = {
...     _id : "shard1",
...      members : [
...          {_id : 0, host : "192.168.252.121:27001" },
...          {_id : 1, host : "192.168.252.122:27001" },
...          {_id : 2, host : "192.168.252.123:27001" , arbiterOnly: true }
...      ]
...  }
{
	"_id" : "shard1",
	"members" : [
		{
			"_id" : 0,
			"host" : "192.168.252.121:27001"
		},
		{
			"_id" : 1,
			"host" : "192.168.252.122:27001"
		},
		{
			"_id" : 2,
			"host" : "192.168.252.123:27001",
			"arbiterOnly" : true
		}
	]
}
> rs.initiate(config)
{ "ok" : 1 }
```

此时会发现终端上的输出已经有了变化。

```sh
//从单个一个
>
//变成了
shard1:SECONDARY>
```

查询状态

```sh
shard1:SECONDARY> rs.status()
```

## 3.2 设置第二个分片副本集

设置第二个分片副本集

配置文件

```sh
vi /usr/local/mongodb/conf/shard2.conf

#配置文件内容
#——————————————–
pidfilepath = /usr/local/mongodb/shard2/log/shard2.pid
dbpath = /usr/local/mongodb/shard2/data
logpath = /usr/local/mongodb/shard2/log/shard2.log
logappend = true

bind_ip = 0.0.0.0
port = 27002
fork = true
 
#副本集名称
replSet=shard2
 
#declare this is a shard db of a cluster;
shardsvr = true
 
#设置最大连接数
maxConns=20000
```

启动三台服务器的shard2 server

```sh
mongod -f /usr/local/mongodb/conf/shard2.conf
```

连接 MongoDB

```sh
mongo --port 27002
```

使用admin数据库

```sh
use admin
```

定义副本集配置

```sh
config = {
    _id : "shard2",
     members : [
         {_id : 0, host : "192.168.252.121:27002"  , arbiterOnly: true },
         {_id : 1, host : "192.168.252.122:27002" },
         {_id : 2, host : "192.168.252.123:27002" }
     ]
 }
```

初始化副本集配置

```sh
rs.initiate(config)
```

响应内容如下

```sh
> use admin
switched to db admin
> config = {
...     _id : "shard2",
...      members : [
...          {_id : 0, host : "192.168.252.121:27002"  , arbiterOnly: true },
...          {_id : 1, host : "192.168.252.122:27002" },
...          {_id : 2, host : "192.168.252.123:27002" }
...      ]
...  }
{
	"_id" : "shard2",
	"members" : [
		{
			"_id" : 0,
			"host" : "192.168.252.121:27002",
			"arbiterOnly" : true
		},
		{
			"_id" : 1,
			"host" : "192.168.252.122:27002"
		},
		{
			"_id" : 2,
			"host" : "192.168.252.123:27002"
		}
	]
}
> rs.initiate(config)
{ "ok" : 1 }
shard2:SECONDARY> rs.status()
```

## 3.3 设置第三个分片副本集

```sh
vi /usr/local/mongodb/conf/shard3.conf

#配置文件内容
#——————————————–
pidfilepath = /usr/local/mongodb/shard3/log/shard3.pid
dbpath = /usr/local/mongodb/shard3/data
logpath = /usr/local/mongodb/shard3/log/shard3.log
logappend = true

bind_ip = 0.0.0.0
port = 27003
fork = true

#副本集名称
replSet=shard3
 
#declare this is a shard db of a cluster;
shardsvr = true
 
#设置最大连接数
maxConns=20000
```

启动三台服务器的shard3 server

```sh
mongod -f /usr/local/mongodb/conf/shard3.conf
```

登陆任意一台服务器，初始化副本集(除了192.168.252.121)

```sh
mongo --port 27003
```

使用admin数据库

```sh
use admin
```

定义副本集配置

```sh
config = {
    _id : "shard3",
     members : [
         {_id : 0, host : "192.168.252.121:27003" },
         {_id : 1, host : "192.168.252.122:27003" , arbiterOnly: true},
         {_id : 2, host : "192.168.252.123:27003" }
     ]
 }
```

初始化副本集配置

```sh
rs.initiate(config)
```

响应内容如下

```sh
> use admin
switched to db admin
> config = {
...     _id : "shard3",
...      members : [
...          {_id : 0, host : "192.168.252.121:27003" },
...          {_id : 1, host : "192.168.252.122:27003" , arbiterOnly: true},
...          {_id : 2, host : "192.168.252.123:27003" }
...      ]
...  }
{
	"_id" : "shard3",
	"members" : [
		{
			"_id" : 0,
			"host" : "192.168.252.121:27003"
		},
		{
			"_id" : 1,
			"host" : "192.168.252.122:27003",
			"arbiterOnly" : true
		},
		{
			"_id" : 2,
			"host" : "192.168.252.123:27003"
		}
	]
}
> rs.initiate(config)
{ "ok" : 1 }
shard3:SECONDARY> rs.status()
```

## 3.4 配置路由服务器 mongos

（三台机器）先启动配置服务器和分片服务器,后启动路由实例启动路由实例:

```sh
vi /usr/local/mongodb/conf/mongos.conf

#内容
pidfilepath = /usr/local/mongodb/mongos/log/mongos.pid
logpath = /usr/local/mongodb/mongos/log/mongos.log
logappend = true

bind_ip = 0.0.0.0
port = 20000
fork = true

#监听的配置服务器,只能有1个或者3个 configs为配置服务器的副本集名字
configdb = configs/192.168.252.121:21000,192.168.252.122:21000,192.168.252.123:21000
 
#设置最大连接数
maxConns = 20000
```

启动三台服务器的mongos server

```sh
mongos -f /usr/local/mongodb/conf/mongos.conf
```

## 3.5 启用分片

目前搭建了mongodb配置服务器、路由服务器，各个分片服务器，不过应用程序连接到mongos路由服务器并不能使用分片机制，还需要在程序里设置分片配置，让分片生效。

登陆任意一台mongos

```sh
mongo --port 20000
```

使用admin数据库

```sh
use  admin
```

串联路由服务器与分配副本集

```sh
sh.addShard("shard1/192.168.252.121:27001,192.168.252.122:27001,192.168.252.123:27001");
sh.addShard("shard2/192.168.252.121:27002,192.168.252.122:27002,192.168.252.123:27002");
sh.addShard("shard3/192.168.252.121:27003,192.168.252.122:27003,192.168.252.123:27003");
```

查看集群状态

```sh
sh.status()
```

响应内容如下

```sh
mongos> sh.status()
--- Sharding Status --- 
  sharding version: {
  	"_id" : 1,
  	"minCompatibleVersion" : 5,
  	"currentVersion" : 6,
  	"clusterId" : ObjectId("5a713a37d56e076f3eb47acf")
  }
  shards:
        {  "_id" : "shard1",  "host" : "shard1/192.168.252.121:27001,192.168.252.122:27001",  "state" : 1 }
        {  "_id" : "shard2",  "host" : "shard2/192.168.252.122:27002,192.168.252.123:27002",  "state" : 1 }
        {  "_id" : "shard3",  "host" : "shard3/192.168.252.121:27003,192.168.252.123:27003",  "state" : 1 }
  active mongoses:
        "3.6.2" : 3
  autosplit:
        Currently enabled: yes
  balancer:
        Currently enabled:  yes
        Currently running:  no
        Failed balancer rounds in last 5 attempts:  0
        Migration Results for the last 24 hours: 
                No recent migrations
  databases:
        {  "_id" : "config",  "primary" : "config",  "partitioned" : true }

mongos> 
```

# 4 测试

目前配置服务、路由服务、分片服务、副本集服务都已经串联起来了，但我们的目的是希望插入数据，数据能够自动分片。连接在mongos上，准备让指定的数据库、指定的集合分片生效。

登陆任意一台mongos

```sh
mongo --port 20000
```

使用admin数据库

```sh
use  admin
```

指定testdb分片生效

```sh
db.runCommand( { enablesharding :"testdb"});
```

指定数据库里需要分片的集合和片键

```sh
db.runCommand( { shardcollection : "testdb.table1",key : {id: 1} } );
```

我们设置testdb的 table1 表需要分片，根据 id 自动分片到 shard1 ，shard2，shard3 上面去。要这样设置是因为不是所有mongodb 的数据库和表 都需要分片！

测试分片配置结果

连接 MongoDB 路由服务

```sh
mongo  127.0.0.1:20000
```

切换到 testdb 数据库

```sh
use  testdb;
```

插入测试数据

```sh
for(i=1;i<=100000;i++){db.table1.insert({"id":i,"name":"penglei"})};
```

总条数

```sh
db.table1.aggregate([{$group : {_id : "$name", totle : {$sum : 1}}}])
```

查看分片情况如下

```sh
db.table1.stats();
```

**发现数据只会在一个分片上**

创建索引

```sh
db.table1.createIndex({"id":1})
db.table1.createIndex({"id":"hashed"});

db.table1.getIndexes()
```

```sh
sh.shardCollection("testdb.table1",{"id":1})
```

```sh
for(i=100000;i<200000;i++){db.table1.insert({"id":i,"name":"penglei"})}
```

# 后期运维

启动

mongodb的启动顺序是，先启动配置服务器，在启动分片，最后启动mongos.

```sh
mongod -f /usr/local/mongodb/conf/config.conf
mongod -f /usr/local/mongodb/conf/shard1.conf
mongod -f /usr/local/mongodb/conf/shard2.conf
mongod -f /usr/local/mongodb/conf/shard3.conf
mongod -f /usr/local/mongodb/conf/mongos.conf
```

关闭

```sh
#debian、ubuntu系统下：

apt-get install psmisc

#centos或、rhel系统下：

yum install psmisc
```

关闭时，直接killall杀掉所有进程

```sh
killall mongod
killall mongos
```

**参考：**

Runoob 教程：http://www.runoob.com/mongodb/mongodb-tutorial.html  
Tutorials 教程：Pointhttps://www.tutorialspoint.com/mongodb/mongodb_advantages.htm  
MongoDB 官网地址：https://www.mongodb.com  
MongoDB 官方英文文档：https://docs.mongodb.com/manual  
MongoDB 各平台下载地址：https://www.mongodb.com/download-center#community  
MongoDB 安装 https://docs.mongodb.com/manual/tutorial/install-mongodb-enterprise-on-ubuntu  

# Contact

 - 作者：鹏磊  
 - 出处：[http://www.ymq.io/2018/01/29/MongoDB-2](http://www.ymq.io/2018/01/29/MongoDB-2/)  
 - Email：[admin@souyunku.com](admin@souyunku.com)  
 - 版权归作者所有，转载请注明出处
 - Wechat：关注公众号，搜云库，专注于开发技术的研究与知识分享
 
![关注公众号-搜云库](http://www.ymq.io/images/souyunku.png "搜云库")

